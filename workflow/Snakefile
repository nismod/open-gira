from glob import glob
import requests
# import pydevd_pycharm
# pydevd_pycharm.settrace('localhost', port=9991, stdoutToServer=True, stderrToServer=True)

configfile: "config/config.yaml"

# Slugs are NOT allowed to use _ because that's used to separate slugs from one another
dataset_slug = os.path.basename(config["dataset"]).replace(".osm.pbf", "").replace("_", "-")
filter_slug = os.path.basename(config["osmium_tags_filters_file"]).replace(".txt", "").replace("_", "-")

# Constrain wildcards to NOT use _ or /
wildcard_constraints:
    OUTPUT_DIR="[^/]+",
    DATASET="[^_/]+",
    SLICE_SLUG="slice-[0-9]+",
    FILTER_SLUG="filter-[^_/]+",
    HAZARD_SLUG="hazard-[^_/]+",
    FILENAME="[^/]+",

r = requests.get("https://www.worldpop.org/rest/data/pop/cic2020_UNadj_100m")
COUNTRY_CODES = [row["iso3"] for row in r.json()["data"]]

##### load rules #####
include: "rules/download/dryad-gdp.smk"
include: "rules/download/gadm.smk"
include: "rules/download/gridfinder.smk"
include: "rules/download/storm-ibtracs.smk"
include: "rules/download/worldpop-population.smk"
include: "rules/download/wri-powerplants.smk"
include: "rules/download_all.smk"

include: "rules/download_dataset.smk"
include: "rules/filter_osm_data.smk"
include: "rules/create_overall_bbox.smk"
include: "rules/prepare_hazard_datasets.smk"
include: "rules/download_hazard_datasets.smk"
include: "rules/trim_hazard_data.smk"
include: "rules/create_slice_rules.smk"
include: "rules/slice.smk"
include: "rules/convert_to_geoparquet.smk"
include: "rules/intersection.smk"
include: "rules/join_data.smk"

##### target rules #####

# Require the completed single .geoparquet file to be present for each hazard
rule all:
    input:
        expand(
            os.path.join(
                f"{config['output_dir']}",
                f"{dataset_slug}_filter-{filter_slug}.geoparquet"
            ),
            hazard=config['hazard_datasets'].keys()
        )

# Remove intermediate directories
rule clean:
    shell:
        """
        rm -rm {config[output_dir]}/json &&
        rm -rf {config[output_dir]}/geoparquet &&
        rm -rf {config[output_dir]}/slices &&
        rm -rf {config[output_dir]}/splits
        """
