# Testing

The pipeline is tested on a small sample of OpenStreetMap data
representing a region Tanzania. For each rule used in
`workflow/Snakefile` there is a unit test ensuring that the expected
outputs are generated, given inputs based on the test
dataset. 

Unit tests are adapted from those automatically generated unsing 
`snakemake --generate-unit-tests`, see 
[Automatically generating unit tests](https://snakemake.readthedocs.io/en/stable/snakefiles/testing.html) 
on the Snakemake docs.

## Generation of the test dataset

The test dataset was generated by extracting data from a larger
region, [`tanzania-latest`](https://download.geofabrik.de/africa/tanzania-latest.osm.pbf).

The existing pipeline was used to slice the file up into 100 slices, and the 5th slice was
kept as the smallest filesize that contained highway data.

## External files

Some of the tests rely on some external files, i.e. files that should not be a part
of the workflow because they are not produced by the workflow but are instead
located elsewhere.
The download_* rules, for instance, import files from either local or remote
locations.
For testing purposes, we store those remote files outside the working directory
of the test, in `tests/external_files`.

The contents of this directory are:

| filename | description |
|----------|-------------|
| `tanzania-mini.osm.pbf` | OpenStreetMap test data (see [above](#generation-of-the-test-dataset)) |
| `hazard_sources.txt` | Text file that contains the file path to the hazard file below |
| `inunriver_rcp4p5_MIROC-ESM-CHEM_2030_rp00100.tif` | Hazard data raster file |

### NOTE on slices

**Some of the slices in the mini testing dataset do not have highway data.**
When you are writing tests that rely on slices, make sure you use one of the 
slices that _does_ have highway data (**slices 2 and 3**), not one of the slices
that does not have these data (slices 0 and 1).

## Config

The tests have their own configuration, located in `tests/config/config.yaml`.
This config file points identifies the files in `tests/external_files` as 
remote targets for download rules, and the `tests/config/highway-core.txt` file
as the filter rules file.

## Auto-generating the tests

Running `snakemake` with the `--generate-unit-tests` options
automatically create unit tests for each rule in the workflow
file. 
Input data and expected outputs are copied into a specific
directory under `.tests/units`. 
This means that, before generating the
tests, the pipeline must have been successfully run at leat once, in
order for the expected outputs to be there.

## Changes from auto-generated tests

The tests rely on a common output checking mechanism, located in the
automatically generated `tests/unit/common.py`.
This has been adapted to reduce repetition in the test files, by
adding in a `run_test` function that takes the test target name
and command and runs the three-stage test procedure for each.

The test procedure stages are:
1. Setup temporary test environment and copy required files
2. Run the snakemake command being tested
3. Check output against an expected output

The first stage additionally copies across the `tests/config` and 
`tests/external_files` directories to the temporary working directory.
The last stage is specifically told to ignore those directories when
testing the output. 
This will not be a problem unless a rule attempts to modify the
configuration files, which it should not do.

## Adding new tests

When you add a new rule, you should add a new test for the rule.
That is done as follows:

1. Make sure you have a config file that lists your infrastructure
   and hazard data sources as those used in the other tests.
2. Run a snakemake job that executes _only_ your rule.
   1. To do this, you may have to execute prior rules, 
        but make sure you can run your job so that it only
        runs your rule afterwards.
3. Create a new directory `tests/unit/<rule_name>` where `<rule_name>` is 
   the name of your new rule (without angle brackets).
4. Create a new Python file `tests/unit/test_<rule_name>.py`.
5. Inside your `tests/unit/<rule_name>` directory, create two folders:
   1. `data`, containing any files your rule takes as inputs 
      (or an empty `.gitkeep` file if there are no inputs).
   2. `expected` containing any outputs your rule produces
6. Copy the contents of one of the other test files into your 
   `tests/unit/test_<rule_name>.py` file.
   1. Change the function name on line 8 to `test_<rule_name>`.
   2. Change the first argument of the `run_test` call to `<rule_name>`.
   3. Change the second argument of the `run_test` call to be
      the command you wrote to execute _only_ your snakemake job in step 2.
      * If your command includes spaces within quotes, the `run_test` will
        not parse it correctly, and you should instead put each piece
        of the command as a separate entry in a list. Specifying your command
        as a single string is just a shorthand provided by `run_test`;
        you can see within that function that it is expanded to a list anyway
        (`tests/unit/common.py:30-40`).

## Continuous Integration

Tests are run any time a branch is updated, as defined by `.github/workflows/test.yml`.
